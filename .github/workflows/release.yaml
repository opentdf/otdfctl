name: Release

permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  push:
    branches:
      - main

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Generate a token
        id: generate_token
        uses: actions/create-github-app-token@31c86eb3b33c9b601a1f60f98dcbfd1d70f379b4 # v1.10.3
        with:
          app-id: "${{ secrets.APP_ID }}"
          private-key: "${{ secrets.AUTOMATION_KEY }}"

      - name: Release Please
        uses: googleapis/release-please-action@7987652d64b4581673a76e33ad5e98e3dd56832f
        id: release-please
        with:
          token: ${{ steps.generate_token.outputs.token }}
          release-type: go

      - uses: actions/checkout@v4
        if: ${{ steps.release-please.outputs.release_created }}
      - uses: actions/setup-go@v5
        if: ${{ steps.release-please.outputs.release_created }}
        with: 
          go-version-file: go.mod

      - name: GoReleaser
        uses: goreleaser/goreleaser-action@286f3b13b1b49da4ac219696163fb8c1c93e1200 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHORT_SHA: ${{ steps.virtru-values.outputs.commit_sha_short }}
          MACOS_SIGN_PASSWORD: ${{ steps.gcp-secrets.outputs.MACOS_SIGN_P12_PASSWORD }}
          MACOS_NOTARY_ISSUER_ID: 69a6de7f-a5ef-47e3-e053-5b8c7c11a4d1
          MACOS_NOTARY_KEY_ID: 4AJL5YVGAS
        with:
          args: release --clean --snapshot

      - name: Upload GoReleaser Snapshot Artifacts
        if: ${{ (!steps.release-please.outputs.release_created) }}
        uses: actions/upload-artifact@65462800fd760344b1a7b4382951275a0abb4808 # v4.3.3
        with:
          name: dsp.${{ steps.virtru-values.outputs.commit_sha_short }}
          path: |
            dist/*.tar.gz
            dist/*.zip
            dist/*.sig
            dist/*.txt
            dist/*.json
          retention-days: 1

      - id: "commit-sha-short"
        run: |
          commit_sha_short=$(echo ${{ github.event.pull_request.head.sha || github.sha }} | cut -c1-7)
          echo "commit_sha_short=$commit_sha_short" >> "$GITHUB_OUTPUT"


      - name: 'GoReleaser Release'
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        uses: goreleaser/goreleaser-action@286f3b13b1b49da4ac219696163fb8c1c93e1200 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ github.ref_name }}
          MACOS_SIGN_PASSWORD: ${{ steps.gcp-secrets.outputs.MACOS_SIGN_P12_PASSWORD }}
          MACOS_NOTARY_ISSUER_ID: 69a6de7f-a5ef-47e3-e053-5b8c7c11a4d1
          MACOS_NOTARY_KEY_ID: 4AJL5YVGAS
        with:
          args: release --clean