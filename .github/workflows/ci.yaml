name: "CI"

on:
  pull_request: {}
  push:
    branches:
      - main
  schedule:
    - cron: "45 0 * * *"

jobs:
  govulncheck:
    runs-on: ubuntu-latest
    name: Run govulncheck
    steps:
      - id: govulncheck
        uses: golang/govulncheck-action@b625fbe08f3bccbe446d94fbf87fcc875a4f50ee # v1.0.4
        with:
          go-version-file: go.mod
          # Empty input is workaround for open issue: https://github.com/golang/go/issues/70036
          go-version-input: 
          go-package: ./...

  golangci:
    name: lint
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: "go.mod"
          cache: false
      - name: golangci-lint
        uses: golangci/golangci-lint-action@e7fa5ac41e1cf5b7d48e45e42232ce7ada589601 # v9.1.0
        with:
          version: v2.1.0
          # Optional: golangci-lint command line arguments.
          args: --timeout=10m
          only-new-issues: true
  unit:
    name: unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      - uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version-file: "go.mod"
          cache: false
      - name: Unit Tests with the Go CLI
        run: go test ./... -short -race -cover

  e2e:
    name: e2e tests
    runs-on: ubuntu-latest
    steps:
      - name: Start up the platform with deps and containers
        uses: opentdf/platform/test/start-up-with-containers@main
        with:
          platform-ref: "dspx-2445-ec-curve-bug"
      # - uses: opentdf/otdfctl/e2e@dspx-2445-higher-ec-curve-tests
      #   with:
      #     otdfctl-ref: ${{ github.event.pull_request.head.sha }}
      #     bats-args: "--filter-tags '!ec_km_kas' e2e"
      #   env:
      #     TESTRAIL_USER: ${{ secrets.TESTRAIL_USER }}
      #     TESTRAIL_PASS: ${{ secrets.TESTRAIL_PASS }}
      - name: Prepare root key
        id: root-key-prep
        run: |-
          OT_CONFIG_FILE="$(pwd)/opentdf.yaml"
          echo "OT_CONFIG_FILE=$OT_CONFIG_FILE" >> "$GITHUB_ENV"
          # Prepare a root key for use by additional KAS instances
          existing_root_key=$(yq e '.services.kas.root_key' "$OT_CONFIG_FILE" 2>/dev/null || echo "")
          if [ -n "$existing_root_key" ] && [ "$existing_root_key" != "null" ]; then
            echo "Using existing root key from config"
            echo "OT_ROOT_KEY=$existing_root_key" >> "$GITHUB_ENV"
            echo "root_key=$existing_root_key" >> "$GITHUB_OUTPUT"
          else
            echo "Generating a new root key for additional KAS"
            gen_root_key=$(openssl rand -hex 32)
            echo "OT_ROOT_KEY=$gen_root_key" >> "$GITHUB_ENV"
            echo "root_key=$gen_root_key" >> "$GITHUB_OUTPUT"
          fi
        working-directory: ${{ steps.run-platform.outputs.platform-working-dir }}

      - name: Start additional KM EC kas (km-ec-kas-1)
        id: kas-km1
        uses: opentdf/platform/test/start-additional-kas@main
        with:
          ec-tdf-enabled: true
          key-management: true
          kas-name: km-ec-kas-1
          kas-port: 8585
          root-key: ${{ steps.root-key-prep.outputs.root_key }}
      - name: Run EC+KM bats tests (km-ec-kas-1)
        uses: opentdf/otdfctl/e2e@dspx-2445-higher-ec-curve-tests
        with:
          otdfctl-ref: ${{ github.event.pull_request.head.sha }}
          bats-args: "--filter-tags ec_km_kas e2e"
        env:
          EC_KM_ROOT_KEY: ${{ steps.root-key-prep.outputs.root_key }}
          EC_KM_TESTS: "true"
          TESTRAIL_USER: ${{ secrets.TESTRAIL_USER }}
          TESTRAIL_PASS: ${{ secrets.TESTRAIL_PASS }}

  platform-xtest:
    needs:
      - golangci
      - unit
    uses: opentdf/tests/.github/workflows/xtest.yml@main
    with:
      otdfctl-ref: ${{ github.ref }} latest
      platform-ref: main lts
      focus-sdk: go
